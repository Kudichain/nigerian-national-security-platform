"""Malware file feature extraction."""

import hashlib
import math
from typing import Dict, Any, List, Optional
from pathlib import Path
import logging

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)


class MalwareFeatureExtractor:
    """Extract features from files for malware detection."""
    
    def extract_static_features(self, file_metadata: Dict[str, Any]) -> Dict[str, float]:
        """
        Extract static analysis features from file metadata.
        
        Args:
            file_metadata: File metadata including PE info, entropy, etc.
            
        Returns:
            Dictionary of extracted features
        """
        features = {
            # File size features
            'file_size': float(file_metadata.get('file_size', 0)),
            'file_size_log': math.log(file_metadata.get('file_size', 1) + 1),
            
            # Entropy features
            'avg_entropy': self._compute_avg_entropy(
                file_metadata.get('sections_entropy', [])
            ),
            'max_entropy': self._compute_max_entropy(
                file_metadata.get('sections_entropy', [])
            ),
            'entropy_variance': self._compute_entropy_variance(
                file_metadata.get('sections_entropy', [])
            ),
        }
        
        # PE-specific features
        if file_metadata.get('file_type') == 'PE':
            features.update(self._extract_pe_features(file_metadata))
        
        # YARA matches
        features['yara_match_count'] = float(
            len(file_metadata.get('yara_matches', []))
        )
        features['has_yara_matches'] = 1.0 if features['yara_match_count'] > 0 else 0.0
        
        return features
    
    def _extract_pe_features(self, file_metadata: Dict[str, Any]) -> Dict[str, float]:
        """Extract PE-specific features."""
        pe_imports = file_metadata.get('pe_imports', [])
        
        # Suspicious API calls
        suspicious_apis = {
            'VirtualAlloc', 'VirtualProtect', 'WriteProcessMemory',
            'CreateRemoteThread', 'LoadLibrary', 'GetProcAddress',
            'WinExec', 'ShellExecute', 'URLDownloadToFile',
            'CreateProcess', 'RegSetValue', 'RegDeleteValue'
        }
        
        network_apis = {
            'InternetOpen', 'InternetConnect', 'HttpOpenRequest',
            'send', 'recv', 'socket', 'connect'
        }
        
        crypto_apis = {
            'CryptEncrypt', 'CryptDecrypt', 'CryptAcquireContext'
        }
        
        features = {
            'import_count': float(len(pe_imports)),
            'suspicious_api_count': float(sum(
                1 for api in pe_imports if any(s in api for s in suspicious_apis)
            )),
            'network_api_count': float(sum(
                1 for api in pe_imports if any(s in api for s in network_apis)
            )),
            'crypto_api_count': float(sum(
                1 for api in pe_imports if any(s in api for s in crypto_apis)
            )),
        }
        
        return features
    
    @staticmethod
    def _compute_avg_entropy(entropy_values: List[float]) -> float:
        """Compute average entropy across sections."""
        if not entropy_values:
            return 0.0
        return sum(entropy_values) / len(entropy_values)
    
    @staticmethod
    def _compute_max_entropy(entropy_values: List[float]) -> float:
        """Compute maximum entropy."""
        if not entropy_values:
            return 0.0
        return max(entropy_values)
    
    @staticmethod
    def _compute_entropy_variance(entropy_values: List[float]) -> float:
        """Compute variance in entropy values."""
        if len(entropy_values) < 2:
            return 0.0
        
        avg = sum(entropy_values) / len(entropy_values)
        variance = sum((x - avg) ** 2 for x in entropy_values) / len(entropy_values)
        return variance
    
    @staticmethod
    def compute_file_entropy(file_path: Path) -> float:
        """
        Compute Shannon entropy of a file.
        
        Args:
            file_path: Path to file
            
        Returns:
            Entropy value (0-8)
        """
        if not file_path.exists():
            return 0.0
        
        # Read file in chunks
        byte_counts = [0] * 256
        total_bytes = 0
        
        with open(file_path, 'rb') as f:
            while chunk := f.read(4096):
                for byte in chunk:
                    byte_counts[byte] += 1
                    total_bytes += 1
        
        if total_bytes == 0:
            return 0.0
        
        # Calculate entropy
        entropy = 0.0
        for count in byte_counts:
            if count > 0:
                probability = count / total_bytes
                entropy -= probability * math.log2(probability)
        
        return entropy


if __name__ == "__main__":
    extractor = MalwareFeatureExtractor()
    
    file_metadata = {
        'file_size': 524288,
        'file_type': 'PE',
        'sections_entropy': [6.2, 7.8, 3.1],
        'pe_imports': ['VirtualAlloc', 'WriteProcessMemory', 'CreateRemoteThread'],
        'yara_matches': ['suspicious_strings'],
    }
    
    features = extractor.extract_static_features(file_metadata)
    print("Malware features:", features)

"""Malware detection model training."""

import pandas as pd
from pathlib import Path
from sklearn.ensemble import RandomForestClassifier
import xgboost as xgb
import joblib
import mlflow
import mlflow.xgboost
from datetime import datetime
import logging

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)


class MalwareTrainer:
    """Train malware detection models."""
    
    def __init__(self, experiment_name: str = "sec-ai-malware") -> None:
        self.experiment_name = experiment_name
        mlflow.set_experiment(experiment_name)
    
    def train_static_model(self, data_path: str) -> xgb.XGBClassifier:
        """Train XGBoost on static file features."""
        df = pd.read_parquet(data_path)
        
        feature_cols = [col for col in df.columns if col not in ['label', 'file_hash', 'file_name']]
        X = df[feature_cols].fillna(0)
        y = (df['label'] == 'malicious').astype(int)
        
        with mlflow.start_run(run_name=f"malware_xgb_{datetime.now():%Y%m%d_%H%M%S}"):
            clf = xgb.XGBClassifier(
                n_estimators=200,
                max_depth=8,
                learning_rate=0.1,
                random_state=42
            )
            clf.fit(X, y)
            
            model_path = Path("models/malware/xgb_static_model.pkl")
            model_path.parent.mkdir(parents=True, exist_ok=True)
            joblib.dump(clf, model_path)
            joblib.dump(feature_cols, model_path.parent / "features.pkl")
            
            mlflow.xgboost.log_model(clf, "model")
            logger.info(f"Malware model saved to {model_path}")
        
        return clf


if __name__ == "__main__":
    import argparse
    parser = argparse.ArgumentParser()
    parser.add_argument("--data", required=True)
    args = parser.parse_args()
    
    trainer = MalwareTrainer()
    trainer.train_static_model(args.data)

"""Malware file collector and EDR agent."""

import json
import logging
import hashlib
from typing import Optional, List
from pathlib import Path
from datetime import datetime
from kafka import KafkaProducer
from schemas.config import get_config
from schemas.data_schemas import MalwareFile

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)


class MalwareCollector:
    """Collects file metadata for malware detection."""
    
    def __init__(self) -> None:
        """Initialize malware collector."""
        config = get_config()
        self.kafka_producer = KafkaProducer(
            bootstrap_servers=config.kafka.bootstrap_servers,
            value_serializer=lambda v: json.dumps(v).encode('utf-8')
        )
        self.topic = config.kafka.topic_malware
        logger.info(f"Malware collector initialized, sending to topic: {self.topic}")
    
    def compute_hash(self, file_path: Path) -> str:
        """Compute SHA256 hash of file."""
        sha256 = hashlib.sha256()
        with open(file_path, 'rb') as f:
            for chunk in iter(lambda: f.read(4096), b""):
                sha256.update(chunk)
        return sha256.hexdigest()
    
    def collect_file(
        self,
        file_path: Path,
        file_type: Optional[str] = None,
        pe_imports: Optional[List[str]] = None,
        sections_entropy: Optional[List[float]] = None,
        ssdeep: Optional[str] = None,
        sandbox_trace_url: Optional[str] = None,
        yara_matches: Optional[List[str]] = None,
    ) -> None:
        """
        Collect and send file metadata for analysis.
        
        Args:
            file_path: Path to file
            file_type: MIME type or PE/ELF
            pe_imports: PE import functions
            sections_entropy: Section entropy values
            ssdeep: Fuzzy hash
            sandbox_trace_url: Link to sandbox analysis
            yara_matches: YARA rule matches
        """
        file_hash = self.compute_hash(file_path)
        file_size = file_path.stat().st_size
        
        malware_file = MalwareFile(
            file_hash=file_hash,
            file_name=file_path.name,
            file_size=file_size,
            file_type=file_type,
            pe_imports=pe_imports,
            sections_entropy=sections_entropy,
            ssdeep=ssdeep,
            sandbox_trace_url=sandbox_trace_url,
            yara_matches=yara_matches,
            label=None,
        )
        
        self.kafka_producer.send(self.topic, malware_file.model_dump(mode='json'))
        logger.debug(f"Sent file metadata: {file_hash}")
    
    def close(self) -> None:
        """Close Kafka producer."""
        self.kafka_producer.flush()
        self.kafka_producer.close()
        logger.info("Malware collector closed")


if __name__ == "__main__":
    # Example usage
    collector = MalwareCollector()
    
    # Note: This is for demonstration - would need actual file analysis
    logger.info("Malware collector ready. Use collect_file() to submit files for analysis.")
    
    collector.close()
